{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/finalizar_os.css' %}">
{% endblock head %}

{% block body %}
<div class="container">

    <!-- Painel esquerdo: Finalizar OS -->
    <div class="panel finalizar-os">

        <form method="post" action="{% url 'finalizar_os' %}" id="finalizarForm">
            {% csrf_token %}

            <!-- Número da OS -->
            <div class="form-group">
                <label for="numero_os">Número da OS</label>
                <input type="text" id="numero_os" name="numero_os" class="input-field" required>
            </div>

            <!-- Dados da OS -->
            <div id="dados-os">

                <div class="form-group">
                    <label>Descrição</label>
                    <textarea id="descricao_os" class="input-field" readonly rows="4"></textarea>
                </div>

                <div class="form-group">
                    <label>Situação Atual</label>
                    <input type="text" id="situacao_os" class="input-field" readonly>
                </div>

                <!-- Observações -->
                <div class="form-group">
                    <label for="observacoes">Observações</label>
                    <textarea name="observacoes" id="observacoes" class="input-field" rows="4" required></textarea>
                    <p class="field-error" id="erroObservacoes" style="display:none;">É obrigatório informar uma observação.</p>
                </div>

                {% if erro %}
                <p class="field-error">{{ erro }}</p>
                {% endif %}

                <input type="hidden" name="numero_os_hidden" id="numero_os_hidden">

                <!-- Botão finalizar -->
                <button type="submit" class="save-btn">✅ Finalizar OS</button>

            </div>

        </form>

    </div>

    <!-- Painel direito: Lista de OS -->
    <div class="panel tabela-os">
        <h2>Ordens em Aberto</h2>

        <!-- Campo de busca -->
        <input type="text" id="buscarTabela" class="input-field search-input"
            placeholder="Buscar por número, descrição, cliente ou situação...">

        <div class="os-table-container">
            {% if ordens %}
            <table class="os-table" id="tabelaOs">
                <thead>
                    <tr>
                        <th>Nº OS</th>
                        <th>Descrição</th>
                        <th>Cliente</th>
                        <th>Situação</th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in ordens %}
                    <tr class="linha-os {% if o.situacao == 'FI' %}os-finalizada{% else %}os-aberta{% endif %}"
                        data-numero="{{ o.numero_os }}"
                        data-descricao="{{ o.descricao_os }}"
                        data-situacao="{{ o.get_situacao_display }}">
                        <td>{{ o.numero_os }}</td>
                        <td>{{ o.descricao_os }}</td>
                        <td>{{ o.cliente }}</td>
                        <td>{{ o.get_situacao_display }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Nenhuma OS encontrada.</p>
            {% endif %}
        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const numeroInput = document.getElementById("numero_os");
    const descricaoInput = document.getElementById("descricao_os");
    const situacaoInput = document.getElementById("situacao_os");
    const hiddenInput = document.getElementById("numero_os_hidden");
    const observacoesInput = document.getElementById("observacoes");
    const erroObs = document.getElementById("erroObservacoes");
    const form = document.getElementById("finalizarForm");

    // =============================
    // Buscar OS via fetch
    // =============================
    function buscarOS(numero) {
        if (!numero) {
            descricaoInput.value = "";
            situacaoInput.value = "";
            hiddenInput.value = "";
            return;
        }

        fetch(`/relatorio/buscar-os/${numero}/`)
            .then(res => res.json())
            .then(data => {
                if (data.erro) {
                    descricaoInput.value = "";
                    situacaoInput.value = "";
                    hiddenInput.value = "";
                    return;
                }
                descricaoInput.value = data.descricao;
                situacaoInput.value = data.situacao;
                hiddenInput.value = numero;
            })
            .catch(() => {
                descricaoInput.value = "";
                situacaoInput.value = "";
                hiddenInput.value = "";
            });
    }

    // =============================
    // Auto buscar ao digitar
    // =============================
    numeroInput.addEventListener("keyup", () => buscarOS(numeroInput.value.trim()));
    numeroInput.addEventListener("change", () => buscarOS(numeroInput.value.trim()));
    numeroInput.addEventListener("blur", () => buscarOS(numeroInput.value.trim()));

    // =============================
    // Preencher ao clicar na tabela
    // =============================
    document.querySelectorAll(".linha-os").forEach(row => {
        row.addEventListener("click", function () {
            let numero = this.dataset.numero;
            numeroInput.value = numero;
            descricaoInput.value = this.dataset.descricao;
            situacaoInput.value = this.dataset.situacao;
            observacoesInput.value = this.dataset.observacao;
            hiddenInput.value = numero;
        });
    });

    // =============================
    // Validação de Observações
    // =============================
    form.addEventListener("submit", function (e) {
        if (observacoesInput.value.trim() === "") {
            e.preventDefault();
            erroObs.style.display = "block";
            observacoesInput.focus();
        } else {
            erroObs.style.display = "none";
        }
    });

    // =============================
    // Filtro da tabela
    // =============================
    const buscarTabela = document.getElementById("buscarTabela");
    buscarTabela.addEventListener("keyup", function () {
        let filtro = this.value.toLowerCase();
        document.querySelectorAll("#tabelaOs tbody tr").forEach(linha => {
            let texto = linha.innerText.toLowerCase();
            linha.style.display = texto.includes(filtro) ? "" : "none";
        });
    });

});
</script>

{% endblock %}
