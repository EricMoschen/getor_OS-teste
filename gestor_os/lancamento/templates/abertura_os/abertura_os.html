{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/abrir_os.css' %}">
{% endblock head %}

{% block body %}
<div class="container">

  <!-- Painel esquerdo: Formul√°rio Abrir/Editar OS -->
  <div class="panel abrir-os">

    <form method="post" action="{% url 'abrir_os' %}">
      {% csrf_token %}

      <!-- N√∫mero da OS -->
      <div class="form-group">
        <label for="numero_os">N√∫mero da OS</label>
        <input type="text" id="numero_os" name="numero_os"
               value="{{ proximo_numero }}" readonly class="input-field">
      </div>

      <!-- Centro de custo -->
      <div class="form-group">
        <label for="centro_custo">Centro de Custo</label>
        <div class="dropdown-container">
          <div id="dropdownSelected" class="dropdown-selected" tabindex="0">
            {% if selected_centro_label %}{{ selected_centro_label }}{% else %}Selecione um centro de custo{% endif %}
          </div>
          <div id="dropdownList" class="dropdown-list hidden" role="listbox" aria-hidden="true">
            {% for pai in pais_centro_custo %}
              <div class="dropdown-group">
                <div class="dropdown-item parent" data-cod="{{ pai.cod_centro }}" data-label="{{ pai.descricao }}" role="option" aria-expanded="false">
                  <span class="arrow">‚ñ∂</span>
                  <span class="text">{{ pai.descricao }}</span>
                </div>
                <div class="dropdown-children hidden" id="children-{{ pai.cod_centro }}">
                  {% for filho in pai.subcentros.all %}
                    <div class="dropdown-item child" data-cod="{{ filho.cod_centro }}" data-label="{{ filho.descricao }}" role="option">
                      &nbsp;&nbsp;&nbsp;‚Ä¢ <span class="text">{{ filho.descricao }}</span>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
          <input type="hidden" name="centro_custo" id="centro_custo" value="{{ form.initial.centro_custo|default:'' }}">
        </div>
      </div>

      <!-- Campos do formul√°rio -->
      {% for field in form %}
        {% if field.name != "centro_custo" %}
          <div class="form-group">
            {{ field.label_tag }}
            {{ field }}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Bot√µes -->
      <div class="form-actions">
        <button type="submit" class="save-btn">üíæ Abrir OS</button>
        <a href="#" class="delete-btn" style="display:none;">üóëÔ∏è Excluir OS</a>
        <button type="button" class="cancel-btn" style="display:none;">‚Ü©Ô∏è Cancelar Edi√ß√£o</button>
      </div>
    </form>
  </div>

  <!-- Painel direito: Tabela de OS -->
  <div class="panel tabela-os">
    <h2>Ordens de Servi√ßo</h2>
    <div class="os-table-container">
      {% if ordens %}
        <table class="os-table">
          <thead>
            <tr>
              <th>N¬∫ OS</th>
              <th>Descri√ß√£o</th>
              <th>Cliente</th>
              <th>Situa√ß√£o</th>
              <th>A√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            {% for o in ordens %}
              <tr data-os-id="{{ o.pk }}"
                  data-numero-os="{{ o.numero_os }}"
                  data-descricao_os="{{ o.descricao_os }}"
                  data-cliente="{{ o.cliente.pk|stringformat:'s' }}"
                  data-cliente-label="{{ o.cliente.nome }}"
                  data-motivo_intervencao="{{ o.motivo_intervencao.pk|stringformat:'s' }}"
                  data-motivo-label="{{ o.motivo_intervencao.descricao }}"
                  data-ssm="{{ o.ssm }}"
                  data-responsavel="{{ o.responsavel }}"
                  data-prioridade="{{ o.prioridade }}"
                  data-situacao="{{ o.situacao }}"
                  data-centro-custo="{{ o.centro_custo.cod_centro }}"
                  data-centro-label="{{ o.centro_custo.descricao }}">
                <td>{{ o.numero_os }}</td>
                <td>{{ o.descricao_os }}</td>
                <td>{{ o.cliente }}</td>
                <td>{{ o.get_situacao_display }}</td>
                <td>
                  <button class="edit-btn" type="button">‚úèÔ∏è</button>
                  <a href="{% url 'imprimir_os' o.pk %}" target="_blank" class="print-btn">üñ®Ô∏è</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>Nenhuma OS cadastrada ainda.</p>
      {% endif %}
    </div>
  </div>
</div>

<script src="{% static 'js/abrir_os.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const formTitle = document.querySelector('.abrir-os h2');
  const saveBtn = document.querySelector('.save-btn');
  const form = document.querySelector('.abrir-os form');
  const numeroOS = document.getElementById('numero_os');
  const hiddenInput = document.getElementById('centro_custo');
  const selected = document.getElementById('dropdownSelected');
  const deleteBtn = document.querySelector('.delete-btn');
  const cancelBtn = document.querySelector('.cancel-btn');

  // === Fun√ß√£o: preencher formul√°rio para edi√ß√£o ===
  function preencherFormulario(osData) {
    formTitle.textContent = 'Editar OS';
    saveBtn.textContent = 'üíæ Salvar Altera√ß√µes';
    numeroOS.value = osData.numero;
    hiddenInput.value = osData.centroCod;
    selected.textContent = osData.centroLabel;
    form.action = `/lancamento/editar_os/${osData.id}/`;
    deleteBtn.href = `/lancamento/excluir/${osData.id}/`;
    deleteBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';

    // Preenche os campos do form
    for (const [key, value] of Object.entries(osData.campos)) {
      const input = form.querySelector(`[name="${key}"]`);
      if (!input) continue;

      if (input.tagName === 'SELECT') {
        input.value = value.toString();
      } else if (input.type === 'checkbox') {
        input.checked = Boolean(value);
      } else {
        input.value = value;
      }
    }

    // Ajuste espec√≠fico: selects cliente e motivo
    const clienteSelect = form.querySelector('select[name="cliente"]');
    const motivoSelect = form.querySelector('select[name="motivo_intervencao"]');
    if (clienteSelect && osData.campos.cliente) {
      clienteSelect.value = osData.campos.cliente;
    } else if (clienteSelect) {
      clienteSelect.value = "";
}
    if (motivoSelect) motivoSelect.value = osData.campos.motivo_intervencao.toString();
  }

  // === Fun√ß√£o: cancelar edi√ß√£o ===
  cancelBtn.addEventListener('click', () => {
    formTitle.textContent = 'Abrir OS';
    saveBtn.textContent = 'üíæ Abrir OS';
    numeroOS.value = '{{ proximo_numero }}';
    hiddenInput.value = '';
    selected.textContent = 'Selecione um centro de custo';
    form.action = '{% url "abrir_os" %}';
    deleteBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    form.reset();
  });

  // === Bot√£o editar ===
  document.querySelectorAll('.os-table tbody .edit-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      const tr = e.target.closest('tr');
      const osData = {
        id: tr.dataset.osId,
        numero: tr.dataset.numeroOs,
        centroCod: tr.dataset.centroCusto,
        centroLabel: tr.dataset.centroLabel,
        campos: {
          descricao_os: tr.dataset.descricao_os,
          cliente: tr.dataset.cliente || null,
          motivo_intervencao: tr.dataset.motivo_intervencao,
          ssm: tr.dataset.ssm,
          responsavel: tr.dataset.responsavel,
          prioridade: tr.dataset.prioridade,
          situacao: tr.dataset.situacao
        }
      };
      preencherFormulario(osData);
    });
  });

  // === Bot√£o excluir com confirma√ß√£o ===
  deleteBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (confirm("Tem certeza que deseja excluir esta OS?") && deleteBtn.href) {
      window.location.href = deleteBtn.href;
    }
  });

});
</script>

{% endblock %}
