{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/abrir_os.css' %}">
{% endblock head %}

{% block body %}
<div class="container">

  <!-- Painel esquerdo: Formul√°rio Abrir/Editar OS -->
  <div class="panel abrir-os">

    <form method="post" action="{% url 'abrir_os' %}">
      {% csrf_token %}

      <!-- N√∫mero da OS -->
      <div class="form-group">
        <label for="numero_os">N√∫mero da OS</label>
        <input type="text" id="numero_os" name="numero_os" value="{{ proximo_numero }}" readonly class="input-field">
      </div>

      <!-- Centro de custo -->
      <div class="form-group">
        <label for="centro_custo">Centro de Custo</label>
        <div class="dropdown-container">
          <div id="dropdownSelected" class="dropdown-selected" tabindex="0">
            {% if selected_centro_label %}{{ selected_centro_label }}{% else %}Selecione um centro de custo{% endif %}
          </div>
          <div id="dropdownList" class="dropdown-list hidden" role="listbox" aria-hidden="true">
            {% for pai in pais_centro_custo %}
            <div class="dropdown-group">
              <div class="dropdown-item parent" data-cod="{{ pai.cod_centro }}" data-label="{{ pai.descricao }}"
                role="option" aria-expanded="false">
                <span class="arrow">‚ñ∂</span>
                <span class="text">{{ pai.descricao }}</span>
              </div>
              <div class="dropdown-children hidden" id="children-{{ pai.cod_centro }}">
                {% for filho in pai.subcentros.all %}
                <div class="dropdown-item child" data-cod="{{ filho.cod_centro }}" data-label="{{ filho.descricao }}"
                  role="option">
                  &nbsp;&nbsp;&nbsp;‚Ä¢ <span class="text">{{ filho.descricao }}</span>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
          <input type="hidden" name="centro_custo" id="centro_custo" value="{{ form.initial.centro_custo|default:'' }}">
        </div>
      </div>

      <!-- Campos do formul√°rio -->
      {% for field in form %}
      {% if field.name != "centro_custo" %}
      <div class="form-group">
        {{ field.label_tag }}
        {{ field }}
      </div>
      {% endif %}
      {% endfor %}

      <!-- Bot√µes -->
      <div class="form-actions">
        <button type="submit" class="save-btn">üíæ Abrir OS</button>
        <a href="#" class="delete-btn" style="display:none;">üóëÔ∏è Excluir OS</a>
        <button type="button" class="cancel-btn" style="display:none;">‚Ü©Ô∏è Cancelar Edi√ß√£o</button>
      </div>
    </form>
  </div>

  <!-- Painel direito: Tabela de OS -->
  <div class="panel tabela-os">
    <h2>Ordens de Servi√ßo</h2>
    <div class="os-table-container">
      {% if ordens %}
      <table class="os-table">
        <thead>
          <tr>
            <th>N¬∫ OS</th>
            <th>Descri√ß√£o</th>
            <th>Cliente</th>
            <th>Situa√ß√£o</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody>
          {% for o in ordens %}
          <tr data-os-id="{{ o.pk }}" data-numero-os="{{ o.numero_os }}" data-descricao-os="{{ o.descricao_os }}"
            data-cliente="{{ o.cliente.pk|default:'' }}"
            data-motivo-intervencao="{{ o.motivo_intervencao.pk|default:'' }}" data-ssm="{{ o.ssm }}"
            data-situacao="{{ o.situacao }}" data-centro-custo="{{ o.centro_custo.cod_centro }}"
            data-centro-label="{{ o.centro_custo.descricao }}">
            <td>{{ o.numero_os }}</td>
            <td>{{ o.descricao_os }}</td>
            <td>{{ o.cliente }}</td>
            <td>{{ o.get_situacao_display }}</td>
            <td>
              <button type="button" class="edit-btn">‚úèÔ∏è</button>
              <a href="{% url 'imprimir_os' o.pk %}" target="_blank">üñ®Ô∏è</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
      {% else %}
      <p>Nenhuma OS cadastrada ainda.</p>
      {% endif %}
    </div>
  </div>
</div>


<script>
  window.PROXIMO_NUMERO_OS = "{{ proximo_numero }}";
  window.URL_ABRIR_OS = "{% url 'abrir_os' %}";
</script>

<script src="{% static 'js/abrir_os.js' %}"></script>

{% endblock %}]